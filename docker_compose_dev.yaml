x-airflow-common: &airflow-common
  build:
    context: .
    dockerfile: airflow_dev.Dockerfile
    args:
      - AIRFLOW_UID=${AIRFLOW_UID}
  environment:
    - AIRFLOW__CORE__EXECUTOR=${AIRFLOW__CORE__EXECUTOR}
    - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW__DATABASE__SQL_ALCHEMY_CONN}
    - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW__CORE__FERNET_KEY}
    - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW__WEBSERVER__SECRET_KEY}
    - AIRFLOW__CORE__LOAD_EXAMPLES=false
  depends_on:
    airflow_postgres_dev:
      condition: service_healthy
    neo4j_dev:
      condition: service_healthy
  volumes:
    - ./dags:/opt/airflow/dags
    - ./logs_airflow:/opt/airflow/logs
    - ./data:/opt/airflow/data

services:
  neo4j_dev:
    image: neo4j:5-community
    restart: always
    user: ${AIRFLOW_UID}
    environment:
      - NEO4J_AUTH=none
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    ports:
      - "7474:7474" # Port pour l'interface web (Neo4j Browser)
      - "7687:7687" # Port pour le connecteur Bolt (pour les drivers)
    volumes:
      # Volume nommé pour la persistance des données de la base Neo4j
      - neo4j_data_dev:/data
      - ./data:/var/lib/neo4j/import:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
  airflow_postgres_dev:
    image: postgres:14
    restart: always
    # container_name: airflow_postgres_dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - airflow_postgres_data_dev:/var/lib/postgresql/data
    # ports:
    #   - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Ce service exécute une commande temporaire pour initialiser la base de données et créer l'utilisateur.
  init_airflow_db_dev:
    <<: *airflow-common
    restart: no
    # container_name: init_airflow_db_dev
    entrypoint: /bin/bash
    command: >
      -c "airflow db init &&
      airflow users create
      --username ${AIR_FLOW_USER_NAME}
      --password ${AIR_FLOW_USER_PASSWORD}
      --firstname ${AIR_FLOW_USER_FIRST_NAME}
      --lastname ${AIR_FLOW_USER_LAST_NAME}
      --role Admin
      --email ${AIR_FLOW_USER_EMAIL}"

  airflow_webserver_dev:
    <<: *airflow-common
    restart: always
    # container_name: airflow_webserver_dev
    command: webserver
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      retries: 5

  airflow_scheduler_dev:
    <<: *airflow-common
    restart: always
    # container_name: airflow_scheduler_dev
    command: scheduler

  airflow_pgadmin_dev:
    image: dpage/pgadmin4
    restart: always
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "8081:80"
    depends_on:
      airflow_postgres_dev:
        condition: service_healthy
    volumes:
      - ./config_pgadmin_dev.json:/pgadmin4/servers.json

volumes:
  airflow_postgres_data_dev:
  neo4j_data_dev: